name: Send WeChat Notification (Manual)

on:
  push:
    branches:
      - send/wechat
      # - main
      # - release/*
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag (e.g., v2.10.0)'
        required: true
        type: string
        default: 'v2.10.0'
      release_body:
        description: 'Release Content (æ”¯æŒ Markdownï¼Œå¦‚æœåŒ…å« "## English" ä¼šè‡ªåŠ¨åˆ é™¤è¯¥è¡ŒåŠä¹‹åçš„å†…å®¹)'
        required: false
        type: string
        default: |
          ### Features âœ¨
          - dialog: æ–°å¢ onInput å›è°ƒäº‹ä»¶ï¼›ä¿®å¤è°ƒç”¨ input æ–¹å¼ï¼Œvalue ä¸º undefined æ— æ³•æ˜¾ç¤ºè¾“å…¥æ¡†é—®é¢˜([pull/143](https://github.com/Tuya-Community/miniapp-smart-ui/pull/143))
          - picker: æ–°å¢ unitGap å±æ€§ï¼Œç”¨äºè®¾ç½®å•ä½å’Œé€‰æ‹©åˆ—ä¹‹é—´çš„é—´éš”([pull/144](https://github.com/Tuya-Community/miniapp-smart-ui/pull/144))
          - battery: å¯¹é½å…¨æ–° UED è®¾è®¡ï¼Œé‡æ„æ ·å¼å¸ƒå±€ï¼Œsizeé»˜è®¤å€¼ä¿®æ”¹ä¸º24([pull/134](https://github.com/Tuya-Community/miniapp-smart-ui/pull/134), [pull/147](https://github.com/Tuya-Community/miniapp-smart-ui/pull/147))

          ### Bug Fixes  ğŸ›
          - dialog: ä¿®å¤ emptyDisabled é»˜è®¤å€¼ä¸º falseï¼Œå¹¶ä¸”ä¿®æ”¹æäº¤æŒ‰é’®ç¦ç”¨é€»è¾‘([5c88532](https://github.com/Tuya-Community/miniapp-smart-ui/pull/146/commits/5c885324f3f9e3c691f4d840e8fc4120a2088301))

          ## English

          ### Features âœ¨
          - dialog: Added onInput callback event; fixed the issue where calling input method with value as undefined prevents the input box from displaying ([pull/143](https://github.com/Tuya-Community/miniapp-smart-ui/pull/143))
          - picker: Added unitGap property to set the gap between the unit and selection columns ([pull/144](https://github.com/Tuya-Community/miniapp-smart-ui/pull/144))
          - battery: Aligned with the new UED design, restructured style layout, and changed the default value of size to 24 ([pull/134](https://github.com/Tuya-Community/miniapp-smart-ui/pull/134), [pull/147](https://github.com/Tuya-Community/miniapp-smart-ui/pull/147))

          ### Bug Fixes ğŸ›
          - dialog: Fixed the default value of emptyDisabled to false and modified the logic for disabling the submit button ([5c88532](https://github.com/Tuya-Community/miniapp-smart-ui/pull/146/commits/5c885324f3f9e3c691f4d840e8fc4120a2088301))

jobs:
  send_wechat:
    runs-on: ubuntu-latest

    steps:
      - name: Send to WeChat
        env:
          RELEASE_TAG: ${{ inputs.release_tag || 'v2.10.0' }}
          RELEASE_BODY_INPUT: ${{ inputs.release_body }}
        run: |
          # è®¾ç½®é»˜è®¤å‘å¸ƒå†…å®¹ï¼ˆå½“ push è§¦å‘æˆ–æœªæä¾›è¾“å…¥æ—¶ä½¿ç”¨ï¼‰
          if [ -z "$RELEASE_BODY_INPUT" ] || [ "$RELEASE_BODY_INPUT" = "null" ]; then
            RELEASE_BODY=$(cat <<'EOF'
          ### Features âœ¨
          - dialog: æ–°å¢ onInput å›è°ƒäº‹ä»¶ï¼›ä¿®å¤è°ƒç”¨ input æ–¹å¼ï¼Œvalue ä¸º undefined æ— æ³•æ˜¾ç¤ºè¾“å…¥æ¡†é—®é¢˜([pull/143](https://github.com/Tuya-Community/miniapp-smart-ui/pull/143))
          - picker: æ–°å¢ unitGap å±æ€§ï¼Œç”¨äºè®¾ç½®å•ä½å’Œé€‰æ‹©åˆ—ä¹‹é—´çš„é—´éš”([pull/144](https://github.com/Tuya-Community/miniapp-smart-ui/pull/144))
          - battery: å¯¹é½å…¨æ–° UED è®¾è®¡ï¼Œé‡æ„æ ·å¼å¸ƒå±€ï¼Œsizeé»˜è®¤å€¼ä¿®æ”¹ä¸º24([pull/134](https://github.com/Tuya-Community/miniapp-smart-ui/pull/134), [pull/147](https://github.com/Tuya-Community/miniapp-smart-ui/pull/147))

          ### Bug Fixes  ğŸ›
          - dialog: ä¿®å¤ emptyDisabled é»˜è®¤å€¼ä¸º falseï¼Œå¹¶ä¸”ä¿®æ”¹æäº¤æŒ‰é’®ç¦ç”¨é€»è¾‘([5c88532](https://github.com/Tuya-Community/miniapp-smart-ui/pull/146/commits/5c885324f3f9e3c691f4d840e8fc4120a2088301))

          ## English

          ### Features âœ¨
          - dialog: Added onInput callback event; fixed the issue where calling input method with value as undefined prevents the input box from displaying ([pull/143](https://github.com/Tuya-Community/miniapp-smart-ui/pull/143))
          - picker: Added unitGap property to set the gap between the unit and selection columns ([pull/144](https://github.com/Tuya-Community/miniapp-smart-ui/pull/144))
          - battery: Aligned with the new UED design, restructured style layout, and changed the default value of size to 24 ([pull/134](https://github.com/Tuya-Community/miniapp-smart-ui/pull/134), [pull/147](https://github.com/Tuya-Community/miniapp-smart-ui/pull/147))

          ### Bug Fixes ğŸ›
          - dialog: Fixed the default value of emptyDisabled to false and modified the logic for disabling the submit button ([5c88532](https://github.com/Tuya-Community/miniapp-smart-ui/pull/146/commits/5c885324f3f9e3c691f4d840e8fc4120a2088301))
          EOF
          )
          else
            RELEASE_BODY="$RELEASE_BODY_INPUT"
          fi

          # å¦‚æœåŒ…å« "## English"ï¼Œåˆ™åˆ é™¤è¯¥è¡ŒåŠå…¶åé¢çš„æ‰€æœ‰å†…å®¹
          RELEASE_BODY=$(echo "$RELEASE_BODY" | sed '/^## English/,$d' | sed -z 's/[[:space:]]*$//')
          # è·å–å½“å‰æ—¥æœŸ
          RELEASE_DATE=$(date +%Y-%m-%d)
          # ä½¿ç”¨ $'\n' ç¡®ä¿æ¢è¡Œç¬¦è¢«æ­£ç¡®è§£é‡Š
          NEWLINE=$'\n'
          CONTENT="## $RELEASE_TAG($RELEASE_DATE)  ${NEWLINE}  ${NEWLINE}  $RELEASE_BODY"
          PAYLOAD=$(jq -n --arg content "$CONTENT" '{
              "msgtype": "markdown",
              "markdown": {
                  "content": $content
              }
          }')
          curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=${{ secrets.WECHAT_TOKEN }}' \
          -H 'Content-Type: application/json' \
          -d "$PAYLOAD"
          echo "âœ… WeChat notification sent successfully"
